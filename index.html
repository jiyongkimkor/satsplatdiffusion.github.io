<!DOCTYPE html>
<html>
<head>
    <title>SatSplat: Model Selector</title>
    <script type="module">
        import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

        let renderer, camera, controls;
        let currentScene = null;
        const scenes = {};

        const MODELS = {
            asp: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_asp.ply?download=true",
            step1: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_step1_baked.ply?download=true",
            step2: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_step2_baked.ply?download=true"
        };

        async function loadModel(key, url) {
            const scene = new SPLAT.Scene();
            await SPLAT.PLYLoader.LoadAsync(url, scene);
            
            const obj = scene.objects[0];
            if (obj && obj.data && obj.data.positions) {
                const pos = obj.data.positions;
                let minX = Infinity, minY = Infinity, minZ = Infinity;
                let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;

                for (let i = 0; i < pos.length; i += 3) {
                    minX = Math.min(minX, pos[i]); maxX = Math.max(maxX, pos[i]);
                    minY = Math.min(minY, pos[i+1]); maxY = Math.max(maxY, pos[i+1]);
                    minZ = Math.min(minZ, pos[i+2]); maxZ = Math.max(maxZ, pos[i+2]);
                }

                const cX = (minX + maxX) / 2, cY = (minY + maxY) / 2, cZ = (minZ + maxZ) / 2;
                for (let i = 0; i < pos.length; i += 3) {
                    pos[i] -= cX; pos[i+1] -= cY; pos[i+2] -= cZ;
                }
            }
            obj.rotation = SPLAT.Quaternion.FromEuler(new SPLAT.Vector3(Math.PI / 2, 0, 0));
            scenes[key] = scene;
        }

        async function main() {
            const canvas = document.getElementById("mainCanvas");
            renderer = new SPLAT.WebGLRenderer(canvas);
            camera = new SPLAT.Camera();
            controls = new SPLAT.OrbitControls(camera, canvas);

            camera.position = new SPLAT.Vector3(1.5, -0.8, 0.5);
            controls.setCameraTarget(new SPLAT.Vector3(0, 0, 0));

            const resize = () => {
                renderer.setSize(window.innerWidth, window.innerHeight, 1.0);
            };
            window.addEventListener("resize", resize);
            resize();

            // 전역 함수로 등록하여 HTML 버튼에서 호출 가능하게 함
            window.switchModel = (key) => {
                if (!scenes[key]) return;
                currentScene = scenes[key];
                
                // 버튼 스타일 업데이트
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${key}`).classList.add('active');
            };

            const statusEl = document.getElementById("status");
            statusEl.innerText = "Loading Models...";

            try {
                // 병렬 로드
                await Promise.all(Object.entries(MODELS).map(([k, v]) => loadModel(k, v)));
                statusEl.innerText = "All Models Loaded";
                
                // 기본값으로 ASP 설정
                window.switchModel('asp');
            } catch (err) {
                statusEl.innerText = "Error Loading Models";
                console.error(err);
            }

            const frame = () => {
                controls.update();
                if (currentScene) {
                    renderer.render(currentScene, camera);
                }
                requestAnimationFrame(frame);
            };
            requestAnimationFrame(frame);
        }

        main();
    </script>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* 상단 네비게이션 바 */
        #nav-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); padding: 10px; border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1); z-index: 100;
        }

        .nav-btn {
            padding: 10px 24px; border: none; background: transparent;
            color: white; cursor: pointer; border-radius: 25px;
            font-weight: 600; font-size: 14px; transition: all 0.2s;
        }

        .nav-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .nav-btn.active { background: #007aff; color: white; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3); }

        #status {
            position: absolute; bottom: 20px; right: 20px;
            color: rgba(255, 255, 255, 0.5); font-size: 12px; z-index: 100;
        }

        canvas { display: block; width: 100vw; height: 100vh; cursor: move; }
    </style>
</head>
<body>
    <div id="nav-bar">
        <button id="btn-asp" class="nav-btn" onclick="switchModel('asp')">ASP</button>
        <button id="btn-step1" class="nav-btn" onclick="switchModel('step1')">Step 1</button>
        <button id="btn-step2" class="nav-btn" onclick="switchModel('step2')">Step 2</button>
    </div>

    <div id="status">Initializing...</div>
    <canvas id="mainCanvas"></canvas>
</body>
</html>
