<!DOCTYPE html>
<html>
<head>
    <title>SatSplat: 3D Satellite Reconstruction</title>
    <script type="module">
        import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

        let renderer, camera, controls;
        let currentScene = null;
        let currentSite = "068";
        const scenes = {};

        const SITES = ["068", "214", "251", "260"];
        const BASE_URL = "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main";

        function getUrl(site, type) {
            const suffix = type === "asp" ? "asp" : `${type}_baked`;
            return `${BASE_URL}/JAX_${site}_${suffix}.ply?download=true`;
        }

        async function loadSingleModel(site, type) {
            const key = `${site}_${type}`;
            if (scenes[key]) return scenes[key];

            const scene = new SPLAT.Scene();
            await SPLAT.PLYLoader.LoadAsync(getUrl(site, type), scene);
            
            const obj = scene.objects[0];
            if (obj && obj.data && obj.data.positions) {
                const pos = obj.data.positions;
                let minX = Infinity, minY = Infinity, minZ = Infinity, maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;
                for (let i = 0; i < pos.length; i += 3) {
                    minX = Math.min(minX, pos[i]); maxX = Math.max(maxX, pos[i]);
                    minY = Math.min(minY, pos[i+1]); maxY = Math.max(maxY, pos[i+1]);
                    minZ = Math.min(minZ, pos[i+2]); maxZ = Math.max(maxZ, pos[i+2]);
                }
                const cX = (minX + maxX) / 2, cY = (minY + maxY) / 2, cZ = (minZ + maxZ) / 2;
                for (let i = 0; i < pos.length; i += 3) {
                    pos[i] -= cX; pos[i+1] -= cY; pos[i+2] -= cZ;
                }
            }
            obj.rotation = SPLAT.Quaternion.FromEuler(new SPLAT.Vector3(Math.PI / 2, 0, 0));
            scenes[key] = scene;
            return scene;
        }

        async function updateSite(site) {
            currentSite = site;
            document.getElementById("status-text").innerText = `Updating Site: ${site}`;
            document.querySelectorAll('.nav-btn').forEach(b => { b.disabled = true; b.style.opacity = "0.3"; });

            const firstScene = await loadSingleModel(site, "asp");
            currentScene = firstScene;
            switchType("asp");

            document.getElementById("btn-asp").disabled = false;
            document.getElementById("btn-asp").style.opacity = "1";

            ["step1", "step2"].forEach(async (type) => {
                await loadSingleModel(site, type);
                const btn = document.getElementById(`btn-${type}`);
                btn.disabled = false;
                btn.style.opacity = "1";
                if(type === "step2") document.getElementById("status-text").innerText = `Site ${site} Ready`;
            });
        }

        window.switchType = (type) => {
            const key = `${currentSite}_${type}`;
            if (!scenes[key]) return;
            currentScene = scenes[key];
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
        };

        window.changeSite = (e) => updateSite(e.target.value);

        async function main() {
            const canvas = document.getElementById("mainCanvas");
            renderer = new SPLAT.WebGLRenderer(canvas);
            camera = new SPLAT.Camera();
            controls = new SPLAT.OrbitControls(camera, canvas);
            camera.position = new SPLAT.Vector3(1.5, -0.8, 0.5);
            controls.setCameraTarget(new SPLAT.Vector3(0, 0, 0));

            const resize = () => renderer.setSize(window.innerWidth, window.innerHeight, 1.0);
            window.addEventListener("resize", resize);
            resize();

            const frame = () => {
                controls.update();
                if (currentScene) renderer.render(currentScene, camera);
                requestAnimationFrame(frame);
            };
            requestAnimationFrame(frame);
            updateSite("068");
        }
        main();
    </script>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; overflow: hidden; color: white; }
        #header {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 30px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 100; display: flex; justify-content: space-between; align-items: flex-start;
        }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        .subtitle { margin: 4px 0 0; font-size: 0.8rem; color: #aaa; letter-spacing: 0.5px; }
        .workflow { margin-top: 8px; font-size: 0.75rem; color: #007aff; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        #site-selector {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px 15px; border-radius: 8px; font-size: 13px; outline: none; cursor: pointer;
        }

        #nav-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; z-index: 100;
        }
        #nav-bar {
            display: flex; gap: 10px; background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(15px); padding: 8px; border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-btn {
            padding: 10px 22px; border: none; background: transparent;
            color: white; cursor: pointer; border-radius: 12px;
            font-weight: 600; font-size: 12px; transition: all 0.2s; opacity: 0.3;
        }
        .nav-btn.active { background: #007aff; color: white; opacity: 1 !important; }
        #status-bar { font-size: 9px; color: #444; text-transform: uppercase; letter-spacing: 1.5px; }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="header">
        <div>
            <h1>3D Reconstruction with Satellite Images</h1>
            <p class="subtitle">From Traditional Pipeline to Modern Methods</p>
            <p class="workflow">ASP &nbsp; → &nbsp; SatSplat &nbsp; → &nbsp; SatSplat-Diffusion</p>
        </div>
        <select id="site-selector" onchange="changeSite(event)">
            <option value="068">JAX_068</option>
            <option value="214">JAX_214</option>
            <option value="251">JAX_251</option>
            <option value="260">JAX_260</option>
        </select>
    </div>

    <div id="nav-container">
        <div id="nav-bar">
            <button id="btn-asp" class="nav-btn" onclick="switchType('asp')">ASP</button>
            <button id="btn-step1" class="nav-btn" onclick="switchType('step1')">SatSplat</button>
            <button id="btn-step2" class="nav-btn" onclick="switchType('step2')">SatSplat-Diffusion</button>
        </div>
        <div id="status-bar"><span id="status-text">Connecting...</span></div>
    </div>

    <canvas id="mainCanvas"></canvas>
</body>
</html>
