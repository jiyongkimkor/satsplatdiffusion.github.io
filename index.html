<!DOCTYPE html>
<html>
<head>
    <title>SatSplat: 3D Satellite Reconstruction</title>
    <script type="module">
        import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

        let renderer, camera, controls;
        let currentScene = null;
        const scenes = {};

        const MODELS = {
            asp: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_asp.ply?download=true",
            step1: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_step1_baked.ply?download=true",
            step2: "https://huggingface.co/datasets/jiyong1591/SatSplatDiffusion/resolve/main/JAX_068_step2_baked.ply?download=true"
        };

        async function loadSingleModel(key, url) {
            const btn = document.getElementById(`btn-${key}`);
            if(btn) btn.innerText = `Loading...`;

            const scene = new SPLAT.Scene();
            await SPLAT.PLYLoader.LoadAsync(url, scene);
            
            const obj = scene.objects[0];
            if (obj && obj.data && obj.data.positions) {
                const pos = obj.data.positions;
                let minX = Infinity, minY = Infinity, minZ = Infinity;
                let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;

                for (let i = 0; i < pos.length; i += 3) {
                    minX = Math.min(minX, pos[i]); maxX = Math.max(maxX, pos[i]);
                    minY = Math.min(minY, pos[i+1]); maxY = Math.max(maxY, pos[i+1]);
                    minZ = Math.min(minZ, pos[i+2]); maxZ = Math.max(maxZ, pos[i+2]);
                }

                const cX = (minX + maxX) / 2, cY = (minY + maxY) / 2, cZ = (minZ + maxZ) / 2;
                for (let i = 0; i < pos.length; i += 3) {
                    pos[i] -= cX; pos[i+1] -= cY; pos[i+2] -= cZ;
                }
            }
            obj.rotation = SPLAT.Quaternion.FromEuler(new SPLAT.Vector3(Math.PI / 2, 0, 0));
            scenes[key] = scene;

            if(btn) {
                btn.innerText = key.toUpperCase();
                btn.disabled = false;
                btn.style.opacity = "1";
            }
            return scene;
        }

        async function main() {
            const canvas = document.getElementById("mainCanvas");
            renderer = new SPLAT.WebGLRenderer(canvas);
            camera = new SPLAT.Camera();
            controls = new SPLAT.OrbitControls(camera, canvas);

            camera.position = new SPLAT.Vector3(1.5, -0.8, 0.5);
            controls.setCameraTarget(new SPLAT.Vector3(0, 0, 0));

            const resize = () => {
                renderer.setSize(window.innerWidth, window.innerHeight, 1.0);
            };
            window.addEventListener("resize", resize);
            resize();

            window.switchModel = (key) => {
                if (!scenes[key]) return;
                currentScene = scenes[key];
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${key}`).classList.add('active');
            };

            try {
                const firstScene = await loadSingleModel('asp', MODELS.asp);
                currentScene = firstScene;
                document.getElementById('btn-asp').classList.add('active');
                document.getElementById("status-text").innerText = "Background downloading others...";

                loadSingleModel('step1', MODELS.step1);
                loadSingleModel('step2', MODELS.step2).then(() => {
                    document.getElementById("status-text").innerText = "All Models Ready";
                });

            } catch (err) {
                document.getElementById("status-text").innerText = "Load Error";
            }

            const frame = () => {
                controls.update();
                if (currentScene) renderer.render(currentScene, camera);
                requestAnimationFrame(frame);
            };
            requestAnimationFrame(frame);
        }

        main();
    </script>
    <style>
        body { margin: 0; background: #0b0b0b; font-family: -apple-system, sans-serif; overflow: hidden; color: white; }
        #header {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 25px 35px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 100; pointer-events: none;
        }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
        p { margin: 4px 0 0; font-size: 0.85rem; color: #888; }
        #nav-bar {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(15px); padding: 8px; border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1); z-index: 100;
        }
        .nav-btn {
            padding: 12px 24px; border: none; background: transparent;
            color: white; cursor: pointer; border-radius: 10px;
            font-weight: 600; font-size: 13px; transition: all 0.2s;
            opacity: 0.3;
        }
        .nav-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.1); }
        .nav-btn.active { background: #007aff; color: white; opacity: 1 !important; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
        #status-bar {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            font-size: 9px; color: #444; text-transform: uppercase; letter-spacing: 1.5px;
        }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="header">
        <h1>3D Reconstruction with Satellite Images</h1>
        <p>SatSplat Diffusion Refinement Process</p>
    </div>
    <div id="nav-bar">
        <button id="btn-asp" class="nav-btn" onclick="switchModel('asp')" disabled>ASP</button>
        <button id="btn-step1" class="nav-btn" onclick="switchModel('step1')" disabled>Step 1</button>
        <button id="btn-step2" class="nav-btn" onclick="switchModel('step2')" disabled>Step 2</button>
    </div>
    <div id="status-bar"><span id="status-text">Connecting...</span></div>
    <canvas id="mainCanvas"></canvas>
</body>
</html>
